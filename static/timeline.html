<!DOCTYPE html>
<html>
    <head>
        <title>Trace visualisation</title>
        <link rel="stylesheet" type="text/css" href="timeline/timeline.css">
        <style type="text/css">
          div.timeline-event-dot {
              border-style: solid;
              border-width: 2px;
              margin-top: 2px;
              margin-left: 3px;
              border-radius: 2px;
              -moz-border-radius: 2px;
          }
          div.timeline-event-box {
              max-width: 100px;
              }

          div.timeline-event-line {
              opacity: 0;
          }
          div.timeline-event-line:hover {
              opacity: 0.4;
          }

        </style>
    </head>
    <body>
      <div id="info">
        <form>
          <input id="refresh" type="button" value="Refresh" />
          <input id="load" type="button" value="Load more data" />
          <input id="loadrange" type="button" value="Load visible range" />
        </form><span id="label"></span>
      </div>

      <div id="trace-timeline">
      </div>

      <script type="text/javascript" data-main="src/tracemanager" src="src/require.js"></script>
      <script type="text/javascript" src="timeline/timeline.js"></script>
      <script type="text/javascript">
        require(['jquery', 'tracemanager'], function($, tracemanager) {
            $(window).load(function() {
                function logmsg(s) {
                    if (console !== undefined)
                        console.log(s);
                    $("#label").text(s);
                };

                var timelineData;
                var page = 2;

                tr = tracemanager.init_trace("test", {
                    url: "http://localhost:5000/trace/",
                    requestmode: 'GET',
                    syncmode: "none",
                    default_subject: "ktbs4js",
                    format: 'json'
                });

                // specify options
                var options = {
                    "axisOnTop": true,
                    "cluster": true,
                    "width":  "100%",
                    "height": "auto",
                    "minHeight": 100,
                    "stackEvents": false,
                    "showNavigation": false,
                    "style": "box"
                };

                // Instantiate our timeline object.
                var timeline = new links.Timeline(document.getElementById('trace-timeline'));
                // Reference timeline for debug
                window.timeline = timeline;

                function refresh() {
                    // Draw our timeline with the created data and options
                    timelineData = tr.obsels
                    // FIXME: hack to filter out invalid obsels with invalid timestamp
                        .filter(function(o) { return o.begin > 100000 })
                        .map( function(o) {
                        return {
                            "start": new Date(o.begin),
                            "group": o.type,
                            "content": Object.keys(o.attributes).map(function(p) { return p + ":" + o.attributes[p]; }).join(", "),
                            "className": o.type
                        };
                    });
                    logmsg("Displaying " + tr.obsels.length + " obsels");
                    timeline.draw(timelineData, options);

                    // Update displayed range
                    timeline.setVisibleChartRangeAuto();

                }
                $(tr).on("updated", function() {
                    refresh();
                });
                $('#refresh').bind('click', refresh);
                refresh();

                $('#load').bind('click', function () {
                    tr.load_obsels('?page=' + page);
                    page += 1;
                });
                $('#loadrange').bind('click', function () {
                    var range = timeline.getVisibleChartRange();
                    logmsg("Loading data from " + range.start + " to " + range.end);
                    tr.load_obsels('?from=' + range.start.getTime() + '&to=' + range.end.getTime());
                });
            });
        });
        </script>

    </body>
</html>
